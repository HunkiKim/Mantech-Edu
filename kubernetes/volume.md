# Volume
- 컨테이너 내의 파일들은 임시적이다.
  - 컨테이너 문제생기면 파일들이 손상된다.
- 컨테이너간 데이터 공유가 힘들다.
- 위의 이유 외에도 컨테이너의 데이터를 관리하기 위한 볼륨이라는 개념이 등장했다.
## Docker에서의 Volume
- 다소 느슨하고 덜 관리되는 볼륨이라는 개념이 있다.
- 다른 컨테이너에 있거나, 디스크에 디렉토리이다.
- 볼륨 드라이버를 제공하지만, 제한적이다.
- 기본적으로 Docker는 다음과 같은 볼륨 드라이버를 제공합니다:

  - local: 로컬 호스트 파일 시스템에 마운트되는 볼륨을 생성합니다.
  - nfs: NFS(Network File System)를 사용하여 네트워크 상의 공유 디렉터리를 마운트하는 볼륨을 생성합니다.
  - bind: 호스트의 특정 디렉터리를 컨테이너에 마운트하는 볼륨을 생성합니다.
  - tmpfs: 컨테이너의 임시 파일 시스템을 생성하는 볼륨을 생성합니다.
- 그러나 이러한 기본 볼륨 드라이버는 일부 제한 사항이 있습니다. 
  - 예를 들어, 볼륨 드라이버 간 데이터 공유, 데이터 복제 또는 분산 저장소와의 통합과 같은 고급 기능을 지원하지 않습니다. 

## k8s의 Volume
- 쿠버네티스는 다양한 유형의 볼륨을 지원한다. 
- 파드는 여러 볼륨 유형을 동시에 사용할 수 있다. 
- 임시 볼륨 유형은 파드의 수명을 갖지만, 퍼시스턴트 볼륨은 파드의 수명을 넘어 존재한다.
- 기본적으로 볼륨은 디렉터리이며, 일부 데이터가 있을 수 있으며, 파드 내 컨테이너에서 접근할 수 있다. 디렉터리의 생성 방식, 이를 지원하는 매체와 내용은 사용된 특정 볼륨의 유형에 따라 결정된다.

### 사용 방법
- 볼륨을 사용하려면, .spec.volumes 에서 파드에 제공할 볼륨을 지정하고 .spec.containers[*].volumeMounts 의 컨테이너에 해당 볼륨을 마운트할 위치를 선언한다. 
- 컨테이너의 프로세스는 컨테이너 이미지의 최초 내용물과 컨테이너 안에 마운트된 볼륨(정의된 경우에 한함)으로 구성된 파일시스템을 보게 된다. 
- 프로세스는 컨테이너 이미지의 최초 내용물에 해당되는 루트 파일시스템을 보게 된다. 
- 쓰기가 허용된 경우, 해당 파일시스템에 쓰기 작업을 하면 추후 파일시스템에 접근할 때 변경된 내용을 보게 될 것이다. 
- 볼륨은 이미지의 특정 경로에 마운트된다. 파드에 정의된 각 컨테이너에 대해, 컨테이너가 사용할 각 볼륨을 어디에 마운트할지 명시해야 한다.
- 볼륨은 다른 볼륨 안에 마운트될 수 없다 (하지만, 서브패스 사용에서 관련 메커니즘을 확인한다). 
- 또한, 볼륨은 다른 볼륨에 있는 내용물을 가리키는 하드 링크를 포함할 수 없다.

## 볼륭 유형들
- awsElasticBlockStore
  - 사용 중단됨
  - ec2만 지원되며, 단일 ec2 인스턴스만 지원해서 사용이 제한적이라 중지했다.
- 컨테이너스토리지인터페이스 (CSI)
  - aws, azure 등 사용 
  - 자세한건 따로 다룰 예정
  - CSI migration이 활성화 된 경우 CSI 드라이버로 리다이렉션한다.
  - 몰론 클러스터에 사용할 CSI 드라이버를 설치해야한다.
- ConfigMap
  - 구성(환경) 데이터를 파드에 주입해주는 방법 정의
  - 컨피그맵에 저장된 데이터는 configMap 유형의 볼륨에서 참조되고 그런 다음에 파드에서 실행되는 컨테이너화된 애플리케이션이 소비한다.
  - 자세한건 따로 다룰 예정
- downwardAPI
  - 볼륨은 애플리케이션에서 다운워드(downward) API 데이터를 사용할 수 있도록 한다.
  -  볼륨 내에서 노출된 데이터를 일반 텍스트 형식의 읽기 전용 파일로 찾을 수 있다.
- emptyDir
  - emptyDir 볼륨은 파드가 노드에 할당될 때 처음 생성되며, 해당 노드에서 파드가 실행되는 동안에만 존재한다. 
  - 이름에서 알 수 있듯이 emptyDir 볼륨은 처음에는 비어있다.
  - 파드 내 모든 컨테이너는 emptyDir 볼륨에서 동일한 파일을 읽고 쓸 수 있지만, 해당 볼륨은 각각의 컨테이너에서 동일하거나 다른 경로에 마운트될 수 있다. 
  - 어떤 이유로든 노드에서 파드가 제거되면 emptyDir 의 데이터가 영구적으로 삭제된다.
  - emptyDir 의 일부 용도는 다음과 같다.
    - 디스크 기반의 병합 종류와 같은 스크레치 공간
      - 컨테이너의 임시 공간
    - 충돌로부터 복구하기위해 긴 계산을 검사점으로 지정
      - 컨테이너간 데이터 공유
    - 웹 서버 컨테이너가 데이터를 처리하는 동안 컨텐츠 매니저 컨테이너가 가져오는 파일을 보관
      - 파일 공유를 통해 데이터 처리
      - ex: 생성 -> 웹서버, 처리 -> 컨텐츠매니저
- fc
  - fc 볼륨 유형은 기존 파이버 채널 블록 스토리지 볼륨을 파드에 마운트할 수 있게 한다. 
  - 볼륨 구성에서 targetWWNs 파라미터를 사용하여 단일 또는 다중 대상 월드 와이드 이름(WWN)을 지정할 수 있다.
- hostPath
  - 볼륨은 호스트 노드의 파일시스템에 있는 파일이나 디렉터리를 파드에 마운트 한다. 
  - HostPath 볼륨에는 많은 보안 위험이 있으며, 가능하면 HostPath를 사용하지 않는 것이 좋다. 
  - HostPath 볼륨을 사용해야 하는 경우, 필요한 파일 또는 디렉터리로만 범위를 지정하고 ReadOnly로 마운트해야 한다.
- iscsi
  - iscsi 볼륨을 사용하면 기존 iSCSI (SCSI over IP) 볼륨을 파드에 마운트 할수 있다. - 파드를 제거할 때 지워지는 emptyDir 와는 다르게 iscsi 볼륨의 내용은 유지되고, 볼륨은 그저 마운트 해제만 된다. 
  - 이 의미는 iscsi 볼륨에 데이터를 미리 채울 수 있으며, 파드간에 데이터를 공유할 수 있다는 것이다.
- local
  - local 볼륨은 디스크, 파티션 또는 디렉터리 같은 마운트된 로컬 스토리지 장치를 나타낸다.
  - 로컬 볼륨은 정적으로 생성된 퍼시스턴트볼륨으로만 사용할 수 있다. 동적으로 프로비저닝된 것은 지원되지 않는다.
  - local 볼륨을 사용하는 경우 퍼시스턴트볼륨 nodeAffinity 를 설정해야 합니다. 
- nfs
  - nfs 볼륨을 사용하면 기존 NFS (네트워크 파일 시스템) 볼륨을 파드에 마운트 할수 있다. 
  - 파드를 제거할 때 지워지는 emptyDir 와는 다르게 nfs 볼륨의 내용은 유지되고, 볼륨은 그저 마운트 해제만 된다. 
  - 이 의미는 NFS 볼륨에 데이터를 미리 채울 수 있으며, 파드 간에 데이터를 공유할 수 있다는 뜻이다. NFS는 여러 작성자가 동시에 마운트할 수 있다.
- persistentVolumeClaim 
  - persistentVolumeClaim 볼륨은 퍼시스턴트볼륨을 파드에 마운트하는데 사용한다.
  - 퍼시스턴트볼륨클레임은 사용자가 특정 클라우드 환경의 세부 내용을 몰라도 내구성이있는 스토리지 (GCE 퍼시스턴트디스크 또는 iSCSI 볼륨와 같은)를 "클레임" 할 수 있는 방법이다.


## Persistent Volume(PV)

## CSI
- Container Storage Interface (CSI)는 컨테이너 오케스트레이션 시스템과 스토리지 시스템 간의 표준 인터페이스입니다. 
- CSI는 Kubernetes를 포함한 다양한 컨테이너 오케스트레이션 플랫폼에서 스토리지 제공자와 통합할 수 있도록 설계되었습니다.
- 기존에는 Kubernetes에서 스토리지 볼륨을 관리하기 위해 특정 클라우드 제공자에 종속적인 볼륨 플러그인을 사용해야 했습니다. 
- CSI의 등장으로 클라우드 제공자별로 독립적인 스토리지 드라이버를 개발하고 배포할 수 있게 되었습니다. 
- 이는 벤더 중립성과 플러그 가능성을 제공하므로 다양한 스토리지 시스템을 사용할 수 있게 됩니다.
